name: Convert XMLA to BIM and Upload to Power BI

on:
  push:
    paths:
      - "aa.xmla"
    branches:
      - main

jobs:
  convert-and-upload:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download and Extract Tabular Editor
        run: |
          Invoke-WebRequest -Uri "https://github.com/otykier/TabularEditor/releases/download/2.16.4/TabularEditor.Portable.zip" -OutFile "TabularEditor.zip"
          Expand-Archive -Path "TabularEditor.zip" -DestinationPath "TabularEditor"
          Remove-Item "TabularEditor.zip"

      - name: Verify Tabular Editor Installation
        run: |
          ls -l TabularEditor  # Check if extracted properly

      - name: Check XMLA File
        run: |
          if [ -f "aa.xmla" ]; then echo "aa.xmla found"; else echo "aa.xmla NOT found"; fi

      - name: Convert XMLA to BIM
        run: |
          ./TabularEditor/TabularEditor.exe aa.xmla -B Model.bim || echo "Conversion failed!"

      - name: Check if Model.bim Exists
        run: |
          ls -l
          if [ -f "Model.bim" ]; then echo "Model.bim found"; else echo "Model.bim NOT found"; exit 1; fi

      - name: Upload BIM to Power BI Workspace
        run: |
          ./TabularEditor/TabularEditor.exe Model.bim -D "powerbi://api.powerbi.com/v1.0/myorg/Tungsten%20Automation" -O
